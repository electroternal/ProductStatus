<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colector de Datos de Lote</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; }
        .container { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 800px; margin: 0 auto; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; margin-bottom: 20px; }
        .btn { background-color: #007BFF; color: white; padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 18px; margin-top: 10px; font-weight: bold; }
        .btn-secondary { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        #scanner-section { border: 2px dashed #ccc; padding: 10px; border-radius: 8px; }
        #qr-reader { width: 100%; }
        #current-lot-section { background-color: #e9f5ff; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #b3d7ff; }
        #json-output { background-color: #272822; color: #f8f8f2; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        #table-wrapper { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; min-width: 600px; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Colector de Datos de Lote</h1>
        <button id="start-scan-btn" class="btn">Escanear Nuevo Lote</button>
        <div id="scanner-section" class="hidden">
            <div id="qr-reader"></div>
            <button id="cancel-scan-btn" class="btn btn-secondary">Cancelar</button>
        </div>
        <div id="current-lot-section" class="hidden">
            <h2>Datos del Lote Escaneado</h2>
            <pre><code id="json-output"></code></pre>
            <button id="add-to-table-btn" class="btn">Confirmar y Añadir a la Lista</button>
        </div>
        <div id="collected-data-section" class="hidden">
            <hr style="margin: 25px 0;">
            <h2>Lotes Recopilados</h2>
            <div id="table-wrapper"><table id="data-table"><thead><tr></tr></thead><tbody></tbody></table></div>
            <button id="download-csv-btn" class="btn btn-success">Descargar como CSV</button>
            <button id="email-csv-btn" class="btn btn-warning">Enviar por Email</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

    <script>
        let currentLotData = null, collectedData = [], tableHeaders = [], qrScanner = null;
        const startScanBtn = document.getElementById('start-scan-btn'), scannerSection = document.getElementById('scanner-section'), cancelScanBtn = document.getElementById('cancel-scan-btn'), currentLotSection = document.getElementById('current-lot-section'), jsonOutput = document.getElementById('json-output'), addToTableBtn = document.getElementById('add-to-table-btn'), collectedDataSection = document.getElementById('collected-data-section'), dataTableHeader = document.querySelector('#data-table thead tr'), dataTableBody = document.querySelector('#data-table tbody'), downloadCsvBtn = document.getElementById('download-csv-btn'), emailCsvBtn = document.getElementById('email-csv-btn');
        startScanBtn.addEventListener('click', () => { startScanBtn.classList.add('hidden'); scannerSection.classList.remove('hidden'); qrScanner = new Html5Qrcode("qr-reader"); qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: {width: 250, height: 250} }, onScanSuccess, () => {}); });
        cancelScanBtn.addEventListener('click', () => stopScanner());
        function stopScanner() { if (qrScanner && qrScanner.isScanning) { qrScanner.stop().finally(() => { scannerSection.classList.add('hidden'); startScanBtn.classList.remove('hidden'); }); } else { scannerSection.classList.add('hidden'); startScanBtn.classList.remove('hidden'); } }
        
        function onScanSuccess(decodedText, decodedResult) {
            stopScanner();
            try {
                // --- INICIO DE LA CORRECCIÓN ---
                // 1. Decodificar el texto Base64 a una cadena de texto "cruda"
                const binaryString = atob(decodedText);

                // 2. Convertir la cadena cruda de vuelta a un array de bytes (Uint8Array)
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // 3. Descomprimir el array de bytes para obtener el JSON original.
                const jsonString = pako.inflate(bytes, { to: 'string' });
                // --- FIN DE LA CORRECCIÓN ---

                currentLotData = JSON.parse(jsonString);
                jsonOutput.textContent = JSON.stringify(currentLotData, null, 2);
                currentLotSection.classList.remove('hidden');

            } catch (e) {
                console.error("Error al procesar el QR:", e);
                alert("Error: El código QR es inválido o está corrupto. Intente de nuevo.");
                startScanBtn.classList.remove('hidden');
            }
        }

        addToTableBtn.addEventListener('click', () => {
            const newRowData = { ...currentLotData };
            if (collectedData.length === 0) {
                tableHeaders = Object.keys(newRowData);
                dataTableHeader.innerHTML = tableHeaders.map(h => `<th>${h}</th>`).join('');
                collectedDataSection.classList.remove('hidden');
            }
            collectedData.push(newRowData);
            const newRow = document.createElement('tr');
            newRow.innerHTML = tableHeaders.map(header => `<td>${newRowData[header] || ''}</td>`).join('');
            dataTableBody.appendChild(newRow);
            currentLotSection.classList.add('hidden');
            currentLotData = null;
            startScanBtn.classList.remove('hidden');
        });
        
        function generateCsvString() { if (collectedData.length === 0) return null; const csvRows = [tableHeaders.join(',')]; for (const row of collectedData) { const values = tableHeaders.map(header => `"${(''+(row[header]||'')).replace(/"/g,'""')}"`); csvRows.push(values.join(',')); } return csvRows.join('\n'); }
        downloadCsvBtn.addEventListener('click', () => { const s = generateCsvString(); if(!s){alert("No hay datos.");return;} const b = new Blob([s],{type:'text/csv;charset=utf-8;'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='datos_lotes.csv'; a.click(); });
        emailCsvBtn.addEventListener('click', () => { const s = generateCsvString(); if(!s){alert("No hay datos.");return;} window.location.href=`mailto:?subject=Reporte de Lotes Recopilados&body=${encodeURIComponent(s)}`; });
    </script>
</body>
</html>
