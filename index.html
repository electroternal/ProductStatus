<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capturador de Datos y Fotos</title>
    <style>
        /* El CSS es el mismo, pero agregamos .hidden */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 800px; width: 100%; box-sizing: border-box; }
        h1, h2 { text-align: center; color: #333; }
        .btn { background-color: #007BFF; color: white; padding: 12px 18px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; font-weight: bold; }
        .btn:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }
        #qr-reader { width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ccc; }
        #video-container, #photo-container { text-align: center; margin: 15px 0; }
        #video, #photo { max-width: 100%; border-radius: 4px; }
        #json-display-container pre { background-color: #272822; color: #f8f8f2; padding: 20px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Capturador de Datos y Fotos</h1>

        <!-- Sección del Escáner QR -->
        <div id="scanner-container">
            <div id="qr-reader"></div>
            <p id="qr-reader-status" style="text-align:center; color:#555;">Apunte la cámara al código QR.</p>
        </div>
        
        <!-- Contenido que se mostrará después de escanear -->
        <div id="data-content" class="hidden">
            <!-- Sección de Datos del Producto -->
            <div id="json-display-container">
                <h2>Datos del Producto (desde QR)</h2>
                <pre><code id="json-output"></code></pre>
            </div>

            <!-- Sección de Cámara para Foto -->
            <div id="camera-section">
                <h2>Tomar Fotografía</h2>
                <div id="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" class="hidden"></canvas>
                </div>
                <button id="start-camera" class="btn btn-secondary">Activar Cámara</button>
                <button id="take-photo" class="btn hidden">Tomar Foto</button>
                <div id="photo-container">
                    <img id="photo" class="hidden" alt="Foto capturada">
                </div>
            </div>
            <hr>

            <button id="add-to-table" class="btn" disabled>Añadir a la Tabla</button>
            <hr>

            <!-- Sección de la Tabla de Datos -->
            <div id="table-section">
                <h2>Datos Recopilados</h2>
                <div style="overflow-x:auto;">
                    <table id="data-table">
                        <thead><tr></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button id="download-csv" class="btn btn-success" style="margin-top: 20px;">Descargar CSV</button>
            </div>
        </div>
    </div>

    <!-- Nueva Librería para escanear QR -->
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script>
        // Variables globales (las mismas de antes)
        let jsonData = null;
        let photoDataUrl = null;
        let tableData = [];
        let headers = [];

        // Referencias a los elementos del DOM
        const scannerContainer = document.getElementById('scanner-container');
        const dataContent = document.getElementById('data-content');
        const jsonOutput = document.getElementById('json-output');
        // ... (el resto de las referencias a botones, tablas, etc. son las mismas)

        // Función que se ejecuta cuando el escáner lee un QR con éxito
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);

            try {
                // Parsea el texto decodificado (que es JSON) a un objeto
                jsonData = JSON.parse(decodedText);
                
                // Muestra el JSON en la página
                jsonOutput.textContent = JSON.stringify(jsonData, null, 2);

                // Oculta el escáner y muestra el resto del contenido
                scannerContainer.classList.add('hidden');
                dataContent.classList.remove('hidden');

                // Detiene la cámara del escáner
                html5QrcodeScanner.clear();

                // Habilita el botón de añadir si ya hay una foto (poco probable, pero por si acaso)
                checkEnableAddButton();
                
            } catch (e) {
                alert("Error: El código QR no contiene datos en formato JSON válido.");
                console.error(e);
            }
        }

        function onScanFailure(error) {
            // No hacer nada en caso de fallo, el escáner sigue intentando.
            // console.warn(`QR error = ${error}`);
        }

        // Inicializa el escáner cuando la página carga
        document.addEventListener('DOMContentLoaded', () => {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", 
                { fps: 10, qrbox: { width: 250, height: 250 } }, 
                /* verbose= */ false
            );
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        });
        
        // --- TODO EL CÓDIGO ANTERIOR PARA TOMAR FOTO Y GESTIONAR LA TABLA VA AQUÍ ---
        // (No necesita cambios)

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const startCameraButton = document.getElementById('start-camera');
        const takePhotoButton = document.getElementById('take-photo');
        const addToTableButton = document.getElementById('add-to-table');
        const downloadCsvButton = document.getElementById('download-csv');
        const dataTableBody = document.querySelector('#data-table tbody');
        const dataTableHeader = document.querySelector('#data-table thead tr');

        startCameraButton.addEventListener('click', async () => { /* ...código sin cambios... */ });
        takePhotoButton.addEventListener('click', () => { /* ...código sin cambios... */ });
        addToTableButton.addEventListener('click', () => { /* ...código sin cambios... */ });
        downloadCsvButton.addEventListener('click', () => { /* ...código sin cambios... */ });
        function checkEnableAddButton() { /* ...código sin cambios... */ }
    </script>
</body>
</html>
