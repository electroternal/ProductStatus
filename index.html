<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Data Collection</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --secondary: #4cc9f0;
    --light-bg: #f8fafc;
    --card-bg: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --border: #e2e8f0;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --radius: 12px;
    --radius-lg: 16px;
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', system-ui, sans-serif;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    min-height: 100vh;
    color: var(--text-primary);
    line-height: 1.5;
}

/* Modal */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 1.5rem;
}

.logo {
    position: absolute;
    top: 20px;
    left: 50px;
    height: 60px;
    z-index: -1;
    opacity: 0.5;
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 700px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 2rem;
}

.modal-header {
    margin-bottom: 1.5rem;
}

.modal-content h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
}

.question-group {
    margin-bottom: 1.25rem;
    padding-left: 1.25rem;
    border-left: 2px solid #dbeafe;
}

.question-group p {
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.option {
    display: flex;
    align-items: flex-start;
    margin: 0.5rem 0;
}

.option input[type="radio"] {
    margin-top: 0.375rem;
    margin-right: 0.75rem;
    accent-color: var(--primary);
}

.option label {
    font-size: 0.95rem;
    color: var(--text-secondary);
}

.sub-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-style: italic;
}

.modal-footer {
    text-align: center;
    margin-top: 2rem;
}

.hidden {
    display: none !important;
}

/* Main Layout */
.main-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 2rem;
    gap: 2rem;
    transition: gap 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

.form-column,
.qr-column {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow);
    transition: var(--transition);
}

.form-column {
    flex: 1;
    max-width: 800px;
    z-index: 2;
}

.qr-column {
    width: 400px;
    z-index: 1;
    display: none;
    opacity: 0;
    transform: translateX(30px);
    text-align: center;
}

.main-container.show-qr {
    gap: 2rem;
}

.main-container.show-qr .qr-column {
    display: block;
    opacity: 1;
    transform: translateX(0);
    animation: fadeinQR 0.5s ease-out;
}

@keyframes fadeinQR {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.header-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary);
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-primary);
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--light-bg);
    font-size: 1rem;
    transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: #f0f7ff;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.button-wrapper {
    margin-top: 1.5rem;
}

.btn {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    width: 100%;
    font-size: 1rem;
    font-weight: 600;
    box-shadow: var(--shadow);
    transition: var(--transition);
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px -2px rgba(67, 97, 238, 0.3);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.print-btn {
    margin-top: 1rem;
}

#qr-code {
    margin: 1.5rem auto;
    display: inline-block;
}

#Date[readonly] {
    background: #f0f7ff;
    cursor: not-allowed;
}

/* Responsive */
@media (max-width: 900px) {
    .main-container {
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
    }
    .main-container.show-qr {
        gap: 1rem;
    }
    .form-column,
    .qr-column {
        width: 100%;
        max-width: none;
    }
    .form-grid {
        grid-template-columns: 1fr;
    }
    .qr-column {
        width: 100%;
    }
}

@media (max-width: 600px) {
    .modal-content {
        padding: 1.5rem;
    }
    .header-section {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
    h1 {
        font-size: 1.5rem;
    }
}

/* Additional styles for server app */
.container { max-width:800px; margin:30px auto; padding:20px; }

.card { background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:var(--shadow); margin-bottom:20px; }
.card h2 { margin-bottom:15px; font-size:1.4rem; }

#scanner-section, #current-lot-section, #collected-data-section { display:none; }
#scanner-section.active, #current-lot-section.active, #collected-data-section.active { display:block; }

#qr-reader { width:100%; }

#json-output {
    background:#272822; color:#f8f8f2;
    padding:15px; border-radius:6px;
    white-space:pre-wrap; word-wrap:break-word;
    font-family:'Courier New',Courier,monospace;
    max-height:300px; overflow:auto;
}

.table-wrapper { overflow-x:auto; }
table {
    width:100%; border-collapse:collapse;
}
th, td {
    padding:10px 12px;
    border:var(--border);
    text-align:left;
    white-space: nowrap;
}
thead th { background:#f2f2f2; }
tbody tr:nth-child(even) { background:#fafafa; }
tbody tr:hover { background:#f0f8ff; }

.btn-delete { background:var(--danger); color:#fff; border-radius:4px; padding:4px 8px; font-size:0.9rem; }

#collected-data-section > div:last-child {
    margin-top:15px;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

#collected-data-section .btn {
    width: auto;
    flex: 1;
    min-width: 150px;
}
</style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>Data Collection</h1>
        <button id="start-scan-btn" class="btn btn-primary">Scan New Lot</button>
    </div>

    <!-- Scan Section -->
    <div id="scanner-section" class="card">
        <div id="qr-reader"></div>
        <button id="cancel-scan-btn" class="btn btn-secondary">Cancel</button>
    </div>

    <!-- Current Lot Section -->
    <div id="current-lot-section" class="card">
        <h2>Lot Data</h2>
        <pre id="json-output"></pre>
        <button id="add-to-table-btn" class="btn btn-success">Confirm and add to the list</button>
    </div>

    <!-- Collected Data Section -->
    <div id="collected-data-section" class="card">
        <h2>Scanned Lots</h2>
        <div class="table-wrapper">
            <table id="data-table">
                <thead><tr></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="margin-top:15px;">
            <button id="download-csv-btn" class="btn btn-success">Download as CSV</button>
            <button id="email-csv-btn" class="btn btn-warning">Send via Email</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
let currentLotData = null, collectedData = [], tableHeaders = [], qrScanner = null;
const startScanBtn = document.getElementById('start-scan-btn'),
      scannerSection = document.getElementById('scanner-section'),
      cancelScanBtn = document.getElementById('cancel-scan-btn'),
      currentLotSection = document.getElementById('current-lot-section'),
      jsonOutput = document.getElementById('json-output'),
      addToTableBtn = document.getElementById('add-to-table-btn'),
      collectedDataSection = document.getElementById('collected-data-section'),
      dataTableHeader = document.querySelector('#data-table thead tr'),
      dataTableBody = document.querySelector('#data-table tbody'),
      downloadCsvBtn = document.getElementById('download-csv-btn'),
      emailCsvBtn = document.getElementById('email-csv-btn');

const emailConfig = {
    serviceId: 'REEMPLAZAR_SERVICE_ID',
    templateId: 'REEMPLAZAR_TEMPLATE_ID',
    publicKey: 'REEMPLAZAR_PUBLIC_KEY',
    toEmail: 'destinatario@ejemplo.com'
};

function stringToBase64(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) => String.fromCharCode(parseInt(p1, 16))));
}

if (window.emailjs && emailConfig.publicKey && emailConfig.publicKey !== 'REEMPLAZAR_PUBLIC_KEY') {
    emailjs.init({ publicKey: emailConfig.publicKey });
}

// ---------- Scanning ----------
startScanBtn.addEventListener('click', () => {
    startScanBtn.classList.add('hidden');
    scannerSection.classList.add('active');
    qrScanner = new Html5Qrcode("qr-reader");
    qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: {width: 250, height: 250} },
        onScanSuccess,
        () => {}
    );
});

cancelScanBtn.addEventListener('click', () => stopScanner());
function stopScanner() {
    if (qrScanner && qrScanner.isScanning) {
        qrScanner.stop().finally(() => {
            scannerSection.classList.remove('active');
            startScanBtn.classList.remove('hidden');
        });
    } else {
        scannerSection.classList.remove('active');
        startScanBtn.classList.remove('hidden');
    }
}

function onScanSuccess(decodedText) {
    stopScanner();
    try {
        // 1. Base64 -> binary string
        const binaryString = atob(decodedText);

        // 2. Binary string -> Uint8Array
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }

        // 3. Decompress
        const jsonString = pako.inflate(bytes, { to: 'string' });

        currentLotData = JSON.parse(jsonString);
        jsonOutput.textContent = JSON.stringify(currentLotData, null, 2);
        currentLotSection.classList.add('active');
    } catch (e) {
        console.error("Error al procesar el QR:", e);
        alert("Error: El código QR es inválido o está corrupto. Intente de nuevo.");
        startScanBtn.classList.remove('hidden');
    }
}

// ---------- Add to Table ----------
addToTableBtn.addEventListener('click', () => {
    const newRowData = { ...currentLotData };

    if (collectedData.length === 0) {
        tableHeaders = Object.keys(newRowData);
        dataTableHeader.innerHTML = tableHeaders.map(h => `<th>${h}</th>`).join('');
        collectedDataSection.classList.add('active');
    }

    collectedData.push(newRowData);
    renderTableRow(collectedData.length - 1, newRowData);

    currentLotSection.classList.remove('active');
    currentLotData = null;
    startScanBtn.classList.remove('hidden');
});

function renderTableRow(index, rowData) {
    const tr = document.createElement('tr');
    tr.innerHTML = tableHeaders
        .map(h => `<td>${rowData[h] !== undefined ? rowData[h] : ''}</td>`)
        .join('') + `<td><button class="btn btn-delete" data-index="${index}" title="Eliminar">&#x2715;</button></td>`;
    tr.dataset.idx = index;
    dataTableBody.appendChild(tr);
}

// ---------- Delete Row ----------
dataTableBody.addEventListener('click', e => {
    if (e.target.classList.contains('btn-delete')) {
        const idx = Number(e.target.dataset.index);
        if (!isNaN(idx)) {
            // Remove from array
            collectedData.splice(idx, 1);
            // Re‑render entire table (simpler than manipulating indexes)
            dataTableBody.innerHTML = '';
            collectedData.forEach((row, i) => renderTableRow(i, row));
        }
    }
});

// ---------- CSV Operations ----------
function generateCsvString() {
    if (collectedData.length === 0) return null;
    const csvRows = [tableHeaders.join(',')];
    for (const row of collectedData) {
        const values = tableHeaders.map(header =>
            `"${('' + (row[header] ?? '')).replace(/"/g, '""')}"`
        );
        csvRows.push(values.join(','));
    }
    return csvRows.join('\n');
}

downloadCsvBtn.addEventListener('click', () => {
    const s = generateCsvString();
    if (!s) {
        alert("No hay datos.");
        return;
    }
    const b = new Blob([s], { type: 'text/csv;charset=utf-8;' });
    const u = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = u;
    a.download = 'datos_lotes.csv';
    a.click();
});

emailCsvBtn.addEventListener('click', () => {
    const s = generateCsvString();
    if (!s) {
        alert("No hay datos.");
        return;
    }
    if (!window.emailjs) {
        alert('No se pudo cargar el servicio de email (EmailJS).');
        return;
    }
    if ([emailConfig.serviceId, emailConfig.templateId, emailConfig.publicKey, emailConfig.toEmail].some(v => !v || v.includes('REEMPLAZAR_'))) {
        alert('Actualice la configuración de EmailJS antes de enviar el correo.');
        return;
    }

    const fileName = `datos_lotes_${new Date().toISOString().split('T')[0]}.csv`;
    const dataUri = `data:text/csv;base64,${stringToBase64(s)}`;
    const originalText = emailCsvBtn.textContent;
    emailCsvBtn.disabled = true;
    emailCsvBtn.textContent = 'Enviando...';

    emailjs.send(emailConfig.serviceId, emailConfig.templateId, {
        to_email: emailConfig.toEmail,
        message: 'Se adjunta el archivo CSV con los lotes escaneados.',
        attachments: [
            {
                name: fileName,
                data: dataUri
            }
        ]
    }).then(() => {
        alert('Correo enviado correctamente.');
    }).catch(err => {
        console.error('Error enviando el correo:', err);
        alert('No se pudo enviar el correo. Revise la consola para más detalles.');
    }).finally(() => {
        emailCsvBtn.disabled = false;
        emailCsvBtn.textContent = originalText;
    });
});
</script>
</body>
</html>
